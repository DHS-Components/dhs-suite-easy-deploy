
version: '3.8'

services:
    esa_tf_scheduler:
        image: daskdev/dask:2021.8.1-py3.9
        ports:
            - "8786:8786"
            - "8787:8787"
        command: dask-scheduler

    esa_tf_restapi:
        image: collaborativedhs/esa_tf_restapi:latest
        ports:
            - "8000:8000"
        command: make serve PORT=8000 SCHEDULER="tcp://esa_tf_scheduler:8786"
        volumes:
            - tf-config:/config
            - tf-output:/output
        environment:
            - ESA_TF_CONFIG_FILE=/config/esa_tf.config
            - FORWARDED_ALLOW_IPS=*
            - ROOT_PATH=
            - OUTPUT_DIR=/output

    esa_tf_worker:
        image: collaborativedhs/esa_tf_worker:latest
        depends_on:
            - esa_tf_scheduler
        volumes:
            - tf-config:/config
            - tf-output:/output
            - tf-data:/data
            - tf-plugins:/plugins
            - tf-traces:/traces
        environment:
            - ESA_TF_CONFIG_FILE=/config/esa_tf.config
            - HUBS_CREDENTIALS_FILE=/config/hubs_credentials.yaml
            - TRACEABILITY_CONFIG_FILE=/config/traceability_config.yaml
            - KEY_FILE=/config/secret.txt
            - TRACETOOL_FILE=/opt/tracetool-1.2.4.jar
            - OUTPUT_DIR=/output
            - TRACES_DIR=/traces
            - OUTPUT_OWNER_ID=0
            - OUTPUT_GROUP_OWNER_ID=0
            - TF_DEBUG=0
        command: >
          sh -c 'if \[ -n "$$(ls /plugins/* 2>/dev/null)" \]; then pip install /plugins/* ; fi &&
                 make dask-worker DASKFLAGS="tcp://esa_tf_scheduler:8786"'

    esa_tf_proxy:
        image: nginx:1.21.6
        volumes:
            - ./nginx/templates:/etc/nginx/templates
            - ./nginx/njs:/etc/nginx/njs
            - ./nginx/nginx.conf:/etc/nginx/nginx.conf
            - tf-output:/usr/share/nginx/html
            - tf-logs:/var/log/nginx
        ports:
            - "8070:8080"
        environment:
            - NGINX_HOST=_
            - NGINX_PORT=8080
            - APPLICATION_HOSTNAME=
            - APPLICATION_PROTO=
            - OIDC_ACTIVE=
            - OIDC_ROOT_URL=
            - REALM_NAME=
            - CLIENT_ID=
            - CLIENT_SECRET=
            - KEYCLOAK_HOST_HEADER=
            - GUARD_ROLE=

volumes:
  tf-config:
    driver_opts:
      type: "nfs"
      o: "addr=172.20.7.26,nolock,soft,rw"
      device: ":/shared/tf-config/"
  tf-output:
    driver_opts:
      type: "nfs"
      o: "addr=172.20.7.26,nolock,soft,rw"
      device: ":/shared/tf-output/"
  tf-data:
    driver_opts:
      type: "nfs"
      o: "addr=172.20.7.26,nolock,soft,rw"
      device: ":/shared/tf-data/"
  tf-plugins:
    driver_opts:
      type: "nfs"
      o: "addr=172.20.7.26,nolock,soft,rw"
      device: ":/shared/tf-plugins/"
  tf-traces:
    driver_opts:
      type: "nfs"
      o: "addr=172.20.7.26,nolock,soft,rw"
      device: ":/shared/tf-traces/"
  tf-logs:
    driver_opts:
      type: "nfs"
      o: "addr=172.20.7.26,nolock,soft,rw"
      device: ":/shared/tf-logs/"

networks:
  default:
    external:
      name: collnetwork
